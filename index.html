<!-- Video stream -->
<video id="video" width="640" height="480" autoplay style="display:none;"></video>

<!-- Audio Player -->
<audio id="audioPlayer" controls>
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>

<!-- Mediapipe FaceMesh -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.getElementById('video');
const audioPlayer = document.getElementById('audioPlayer');
let isMuted = false;

// Setup camera
async function setupCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
}

// Initialize FaceMesh
const faceMesh = new FaceMesh({locateFile: (file) => {
    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
}});
faceMesh.setOptions({
    maxNumFaces: 1,
    refineLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
});

// Eye blink detection helper
function getEyeOpenRatio(landmarks, indices) {
    // simple vertical distance / horizontal distance ratio
    const top = landmarks[indices[1]];
    const bottom = landmarks[indices[5]];
    const left = landmarks[indices[0]];
    const right = landmarks[indices[3]];
    const vertical = Math.hypot(top.x - bottom.x, top.y - bottom.y);
    const horizontal = Math.hypot(left.x - right.x, left.y - right.y);
    return vertical / horizontal;
}

faceMesh.onResults(results => {
    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
        const landmarks = results.multiFaceLandmarks[0];
        
        // Right eye indices for blink detection (example)
        const rightEyeIndices = [33, 159, 145, 133, 153, 154];
        const eyeRatio = getEyeOpenRatio(landmarks, rightEyeIndices);

        // Threshold for blink (close eye)
        if (eyeRatio < 0.2 && !isMuted) {
            audioPlayer.volume = 0; // mute
            isMuted = true;
            console.log('Muted by eye blink');
        } else if (eyeRatio >= 0.2 && isMuted) {
            audioPlayer.volume = 1; // unmute
            isMuted = false;
            console.log('Unmuted by eye open');
        }
    }
});

// Start camera
setupCamera().then(() => {
    const camera = new Camera(video, {
        onFrame: async () => {
            await faceMesh.send({image: video});
        },
        width: 640,
        height: 480
    });
    camera.start();
});
</script>
